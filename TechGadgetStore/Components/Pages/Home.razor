@page "/"
@using TechGadgetStore.Data
@using TechGadgetStore.Models
@using Microsoft.EntityFrameworkCore
@using TechGadgetStore.Services
@inject AppDbContext DbContext
@inject NavigationManager Navigation
@inject CartService CartService
@rendermode InteractiveServer

<PageTitle>TechGadgetStore - Home</PageTitle>

<div class="hero-banner">
    <h1>Welcome to TechGadgetStore</h1>
    <p class="lead">Discover the latest tech gadgets and electronics at amazing prices</p>
</div>

<div class="container">
    @if (products == null)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading products...</p>
        </div>
    }
    else if (!products.Any())
    {
        <div class="alert alert-info text-center">
            <h4>No products available yet</h4>
            <p>Check back soon for amazing tech gadgets!</p>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var product in products)
            {
                <div class="col-md-4 mb-4">
                    <div class="card product-card h-100">
                        <div class="product-img-wrapper">
                            <img src="@product.ImageUrl" class="card-img-top" alt="@product.Name">
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@product.Name</h5>
                            <p class="card-text text-muted small mb-2">
                                <span class="badge bg-secondary">@product.Category?.Name</span>
                            </p>
                            <p class="card-text flex-grow-1">@GetShortDescription(product.Description)</p>
                            <div class="mt-auto">
                                @if (product.DiscountPrice.HasValue)
                                {
                                    <div class="mb-2">
                                        <span class="text-decoration-line-through text-muted">$@product.Price</span>
                                        <span class="price-tag discount-price ms-2">$@product.DiscountPrice</span>
                                    </div>
                                }
                                else
                                {
                                    <p class="price-tag mb-2">$@product.Price</p>
                                }
                                
                                @if (product.StockQuantity > 0)
                                {
                                    <div class="d-flex gap-2 mb-2">
                                        <button class="btn btn-primary flex-grow-1" @onclick="() => ViewDetails(product.Id)">
                                            View Details
                                        </button>
                                        <button class="btn btn-success" @onclick="() => AddToCart(product)">
                                            Add to Cart
                                        </button>
                                    </div>
                                    <small class="stock-badge in-stock">In Stock: @product.StockQuantity</small>
                                }
                                else
                                {
                                    <button class="btn btn-secondary w-100 mb-2" disabled>Out of Stock</button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showCartNotification)
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div class="toast show" role="alert">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success!</strong>
                <button type="button" class="btn-close btn-close-white" @onclick="() => showCartNotification = false"></button>
            </div>
            <div class="toast-body">
                Product added to cart!
            </div>
        </div>
    </div>
}

@code {
    private List<Product> products = new();
    private bool showCartNotification = false;

    protected override async Task OnInitializedAsync()
    {
        products = await DbContext.Products
            .Include(p => p.Category)
            .Where(p => p.StockQuantity > 0)
            .ToListAsync();
    }

    private string GetShortDescription(string description)
    {
        if (description.Length <= 100)
            return description;
        return description.Substring(0, 100) + "...";
    }

    private void ViewDetails(int productId)
    {
        Navigation.NavigateTo($"/product/{productId}");
    }

    private void AddToCart(Product product)
    {
        CartService.AddToCart(product);
        showCartNotification = true;
        StateHasChanged();
        
        Task.Delay(3000).ContinueWith(_ => 
        {
            showCartNotification = false;
            InvokeAsync(StateHasChanged);
        });
    }
}
