@page "/product/{id:int}"
@using TechGadgetStore.Data
@using TechGadgetStore.Models
@using Microsoft.EntityFrameworkCore
@using TechGadgetStore.Services
@inject AppDbContext DbContext
@inject CartService CartService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>@product?.Name - TechGadgetStore</PageTitle>

<div class="container mt-4">
    @if (product == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active">@product.Name</li>
            </ol>
        </nav>

        <div class="row">
            <div class="col-md-6">
                <img src="@product.ImageUrl" class="img-fluid rounded" alt="@product.Name">
            </div>
            <div class="col-md-6">
                <h2>@product.Name</h2>
                <p class="text-muted">Category: @product.Category?.Name</p>
                
                <hr>
                
                <div class="mb-3">
                    @if (product.DiscountPrice.HasValue)
                    {
                        <h3>
                            <span class="text-decoration-line-through text-muted">$@product.Price</span>
                            <span class="text-danger ms-3">$@product.DiscountPrice</span>
                        </h3>
                        <p class="text-success">You save: $@(product.Price - product.DiscountPrice.Value)</p>
                    }
                    else
                    {
                        <h3>$@product.Price</h3>
                    }
                </div>

                <div class="mb-3">
                    @if (product.StockQuantity > 0)
                    {
                        <p class="text-success"><strong>In Stock: @product.StockQuantity units available</strong></p>
                    }
                    else
                    {
                        <p class="text-danger"><strong>Out of Stock</strong></p>
                    }
                </div>

                <div class="mb-4">
                    <h5>Description</h5>
                    <p>@product.Description</p>
                </div>

                @if (product.StockQuantity > 0)
                {
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" @onclick="AddToCart">
                            Add to Cart ðŸ›’
                        </button>
                        <button class="btn btn-outline-primary" @onclick="GoToHome">
                            Continue Shopping
                        </button>
                    </div>
                }
                else
                {
                    <button class="btn btn-secondary btn-lg w-100" disabled>Out of Stock</button>
                }

                @if (showNotification)
                {
                    <div class="alert alert-success mt-3">
                        âœ… Product added to cart!
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Product? product;
    private bool showNotification = false;

    protected override async Task OnInitializedAsync()
    {
        product = await DbContext.Products
            .Include(p => p.Category)
            .FirstOrDefaultAsync(p => p.Id == Id);
    }

    private void AddToCart()
    {
        if (product != null)
        {
            CartService.AddToCart(product);
        }
        showNotification = true;
        StateHasChanged();
        
        Task.Delay(3000).ContinueWith(_ => 
        {
            showNotification = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private void GoToHome()
    {
        Navigation.NavigateTo("/");
    }
}